parameters:
  - name: environment
    type: string
    default: dev
  - name: service_connection
    type: string
    default: sc_azure

variables:
  - group: terraform-base
  - group: devops-base
  - group: devops-non-prod
  - group: devops-dev

pool:
  vmImage: ubuntu-22.04

trigger:
  batch: true
  branches:
    include:
      - master
      - main
  paths:
    exclude:
      - terraform/**/*
      - modules/**/*
      - pipelines/infra_deploy_dev.yml
      - pipelines/templates/**/*
      - scripts/**/*

stages:
  - stage: chef
    displayName: Chef Apply
    jobs:
      - deployment: chef_apply
        displayName: Chef Apply
        workspace:
          clean: all
        environment: ${{ parameters.environment }}
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: DownloadSecureFile@1
                  name: idfile
                  inputs:
                    secureFile: id_rsa

                - task: AzureCLI@2
                  displayName: get ip
                  name: ip
                  inputs:
                    azureSubscription: ${{ parameters.service_connection }}
                    scriptType: bash
                    scriptLocation: inlineScript
                    inlineScript: |
                      export fq=$(az network public-ip show -g showtech -n public | jq -r '.ipAddress')
                      echo "fq is ${fq}"
                      echo "##vso[task.setvariable variable=fq;isOutput=true]${fq}"

                - script: echo "fq is $fq"

                - task: Bash@3
                  displayName: knife
                  inputs:
                    targetType: inline
                    script: |
                      knife bootstrap adminuser@$(fq) --node-name aks --ssh-identity-file $(idfile.secureFilePath) --yes --sudo

                - task: Bash@3
                  displayName: rsync
                  inputs:
                    targetType: inline
                    script: |
                      rsync -zavuh -e "ssh -i $(idfile.secureFilePath)" ./cookbooks adminuser@$(fq):~

                - task: Bash@3
                  displayName: chef-client
                  inputs:
                    targetType: inline
                    script: |
                      ssh adminuser@$(fq) -i $(idfile.secureFilePath) "sudo chef-client -zr 'recipe[aks]'"